---
name: Build and Push Docker Image
run-name: Build and Push

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: false
        type: string
        default: ""
    secrets:
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_TOKEN:
        required: false

jobs:
  action-build-and-push:
    runs-on: ubuntu-latest
    environment: ${{ inputs.ENVIRONMENT }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup CI/CD Build and Push
        id: config
        run: |
          sudo apt update -qq >/dev/null 2>&1 && \
          DEBIAN_FRONTEND=noninteractive sudo apt install -y j2cli gettext moreutils >/dev/null 2>&1

          chronic j2 config.yaml -o config.yaml

          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          test -z ${{ inputs.ENVIRONMENT }} && ENVIRONMENT='vacio' || ENVIRONMENT=${{ inputs.ENVIRONMENT }}
          NAME=$(yq -r '.environments.'$ENVIRONMENT'.docker.name // .docker.name // "'$REPO_NAME'" ' config.yaml)
          DOCKERFILE=$(yq -r '.environments.'$ENVIRONMENT'.docker.filename// .docker.filename // "Dockerfile" ' config.yaml)

          echo "üê≥Docker Configuration:"
          echo "  Repo: $REPO_NAME"
          echo "  Environment: $ENVIRONMENT"
          echo "  Input env: .${{ inputs.ENVIRONMENT }}."
          echo "  Dockerfile: $DOCKERFILE"
          echo "  Name: $NAME"

          ls -la
          cat config.yaml
